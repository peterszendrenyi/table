<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSV Data Table</title>
    <style>
        body {
            font-family: sans-serif;
            padding: 2em;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            border: 1px solid #dddddd;
            text-align: left;
            padding: 8px;
        }
        th {
            background-color: #f2f2f2;
        }
        #export-button {
            margin-bottom: 1em;
            padding: 0.5em 1em;
            cursor: pointer;
        }
    </style>
</head>
<body>

    <h1>Data from CSV</h1>
    <button id="export-button">Export CSV</button>
    <div id="table-container"></div>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            // The original URL that we want to fetch
            const originalCsvUrl = 'https://coreapi.ordit.co.uk/public/custom-export?token=edaad3c3cafbe57fc8c29036f23765d93ec5cb654306b3a3ba99ff7bb7722d0ac9f4ef7d75ccd08e805540acc0b030dce39718d67032e5d5b111431483e7417b__;!!PePb2utDNNs!tgy0HqLJXw6pcfSitx0O5cfty7nF_Mn0e6iEfA52nMcfhbLHwssxyaz10Cn29e2KVTzARBjY1BcJ5I_jZtDdSa5LuEkuPrkvbks$';
            
            // We prepend a CORS proxy to the URL to bypass the browser's security restrictions
            const proxiedCsvUrl = `https://thingproxy.freeboard.io/fetch/${originalCsvUrl}`;

            // Function to fetch and display the CSV data
            function displayTable() {
                fetch(proxiedCsvUrl)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`Network response was not ok: ${response.statusText}`);
                        }
                        return response.text();
                    })
                    .then(csvText => {
                        // Check if the response is the expected CSV and not an error page
                        if (csvText.trim().startsWith('{') || csvText.trim().startsWith('<')) {
                           document.getElementById('table-container').innerText = 'Failed to load CSV data. The source might be down or blocking the request.';
                           return;
                        }

                        const rows = csvText.trim().split('\n');
                        const headers = rows.shift().split(',');

                        let table = '<table><thead><tr>';
                        headers.forEach(header => {
                            table += `<th>${header.replace(/"/g, '')}</th>`;
                        });
                        table += '</tr></thead><tbody>';

                        rows.forEach(row => {
                            // Ensure we don't create empty rows for trailing newlines
                            if (row) { 
                                const columns = row.split(',');
                                table += '<tr>';
                                columns.forEach(column => {
                                    table += `<td>${column.replace(/"/g, '')}</td>`;
                                });
                                table += '</tr>';
                            }
                        });

                        table += '</tbody></table>';
                        document.getElementById('table-container').innerHTML = table;
                    })
                    .catch(error => {
                        console.error('Error fetching the CSV file:', error);
                        document.getElementById('table-container').innerText = 'Error loading data. See console for details.';
                    });
            }

            // Add functionality to the export button
            document.getElementById('export-button').addEventListener('click', () => {
                fetch(proxiedCsvUrl)
                    .then(response => response.blob())
                    .then(blob => {
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.style.display = 'none';
                        a.href = url;
                        a.download = 'custom-export.csv';
                        document.body.appendChild(a);
                        a.click();
                        window.URL.revokeObjectURL(url);
                    })
                    .catch(error => console.error('Error downloading the CSV file:', error));
            });

            // Initial load of the table
            displayTable();
        });
    </script>

</body>
</html>
